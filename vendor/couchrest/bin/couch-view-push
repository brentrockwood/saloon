#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../lib/couch_rest'

unless ARGV.length >= 2
  abort 'example: couch-view-push [-a] database_name view_name [view_directory]'
end

view_name     = ARGV.delete('-a') ? 'all' : ARGV.shift 
database_name = ARGV.shift
views_directory = ARGV.shift || 'views'

server = CouchRest.new
database = server.database(database_name)

glob = File.join(Dir.pwd, views_directory)
glob = 
  if view_name == 'all'
    File.join(glob, '**/*.js')
  else
    File.join(glob, view_name, '*.js')
  end

designs_with_views = Dir[glob].inject({}) do |accumulator, view_file|
  parts = view_file.split('/')
  design_name = parts[parts.length-2]
  view = parts.last.gsub(File.extname(parts.last), '')
  view_type = view.split('-').last
  view_name = view.split('-').first

  ((accumulator[design_name] ||= {})[view_name] ||={})[view_type] = File.read(view_file)
  accumulator
end

designs_with_views.each do |design, views|
  doc = { '_id' => "_design/#{design}",
    'language'  => 'javascript',
    'views' => views.inject({}) do |accumulator, view|
      accumulator[view.first] = view.last
      accumulator
    end
  }
  database.save(doc)
end
